<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Punto de Venta | Restaurant Hub</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/sidebar.css">
    <!-- Estilos configuración -->
    <link rel="stylesheet" href="../assets/css/punto_venta.css">
</head>

<body>

    <div class="d-flex">
        <aside class="sidebar">
            <div class="sidebar-header d-flex align-items-center gap-2">
                <i class="bi bi-shop fs-4"></i>
                <span>RestaurantHub</span>
            </div>
            <ul class="sidebar-menu">
                <li><a href="../dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li class="active"><a href="punto_venta.html"><i class="bi bi-receipt"></i> Punto de Venta</a></li>
                <li><a href="caja.html"><i class="bi bi-cash-stack"></i> Caja</a></li>
                <li><a href="reservas.html"><i class="bi bi-calendar-event"></i> Reservas</a></li>
                <li><a href="mesas.html"><i class="bi bi-grid-3x3-gap"></i> Mesas</a></li>
                
                <li><a href="categorias.html"><i class="bi bi-tags"></i> Productos</a></li>
                <li><a href="cocina.html"><i class="bi bi-fire"></i> Producción</a></li>
                
                <li><a href="reportes.html"><i class="bi bi-bar-chart"></i> Reportes</a></li>
                <li><a href="usuarios.html"><i class="bi bi-people"></i> Usuarios</a></li>
                <li><a href="configuracion.html"><i class="bi bi-gear"></i> Configuración</a>
                </li>
            </ul>

        </aside>

        <div class="container-fluid p-4">

            <h2 class="titulo">Punto de Venta</h2>

            <!-- Selección de áreas -->
            <div class="mt-3 mb-3" id="areasTabsPV"></div>

            <!-- Mesas disponibles -->
            <div class="d-flex flex-wrap" id="mesasPV"></div>

            <!-- Modal de pedidos -->
            <div class="modal fade" id="modalPedido" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content modal-dark">
                        <div class="modal-header">
                            <h5 class="modal-title">Mesa <span id="mesaSeleccionada"></span></h5>
                            <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <!-- Productos -->
                                <div class="col-md-8 d-flex flex-wrap" id="productosContainer"></div>

                                <!-- Cuenta -->
                                <div class="col-md-4">
                                    <h4 class="mt-2">Cuenta Actual</h4>

                                    <table class="table table-sm align-middle">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Cant</th>
                                                <th>$</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="cuentaBody"></tbody>
                                    </table>

                                    <h5 class="mt-2">Total: $<span id="totalCuenta">0.00</span></h5>
                                    <hr>

                                    <h6>Propina</h6>
                                    <div class="d-flex gap-2 mb-2">
                                        <button class="btn btn-outline-secondary btn-sm"
                                            onclick="aplicarPropinaPorcentaje(0.10)">10%</button>
                                        <button class="btn btn-outline-secondary btn-sm"
                                            onclick="aplicarPropinaPorcentaje(0.15)">15%</button>
                                        <button class="btn btn-outline-secondary btn-sm"
                                            onclick="aplicarPropinaPorcentaje(0.20)">20%</button>
                                    </div>

                                    <input type="number" class="form-control mb-2" placeholder="Propina en efectivo"
                                        oninput="aplicarPropinaEfectivo(this.value)">

                                    <p>Propina: $<span id="propinaMonto">0.00</span></p>

                                    <hr>

                                    <h6>Forma de pago</h6>
                                    <select class="form-select mb-2" id="formaPago" onchange="actualizarPago()">
                                        <option value="efectivo">Efectivo</option>
                                        <option value="tarjeta">Tarjeta</option>
                                        <option value="mixto">Mixto</option>
                                    </select>

                                    <input type="number" class="form-control mb-2" placeholder="Pago en efectivo"
                                        id="pagoEfectivo" oninput="actualizarPago()">

                                    <p>Cambio: $<span id="cambio">0.00</span></p>

                                    <h5>Total Final: $<span id="totalFinal">0.00</span></h5>

                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button class="btn btn-success" id="confirmarPedido">Confirmar Pedido</button>
                            <button class="btn btn-info" id="imprimirTicket">Imprimir Ticket</button>
                            <button class="btn btn-success" id="cerrarMesa">Cerrar Mesa</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let mesas = JSON.parse(localStorage.getItem('disenoMesas')) || {};
        let areas = Object.keys(mesas);

        const areasTabsPV = document.getElementById('areasTabsPV');
        const mesasPV = document.getElementById('mesasPV');

        const modalPedido = new bootstrap.Modal(document.getElementById('modalPedido'));
        const mesaSeleccionadaSpan = document.getElementById('mesaSeleccionada');
        const productosContainer = document.getElementById('productosContainer');
        const cuentaBody = document.getElementById('cuentaBody');

        const totalCuenta = document.getElementById('totalCuenta');

        let mesaActiva = null;
        let pedidoActual = [];

        // Menú ejemplo (puedes cargar dinámicamente de tu base de datos)
        const menu = [
            { categoria: 'Bebidas', nombre: 'Coca-Cola', precio: 25 },
            { categoria: 'Bebidas', nombre: 'Agua', precio: 15 },
            { categoria: 'Comida', nombre: 'Hamburguesa', precio: 80 },
            { categoria: 'Comida', nombre: 'Pizza', precio: 120 },
            { categoria: 'Postres', nombre: 'Helado', precio: 50 }
        ];

        // Mostrar áreas como botones
        areas.forEach(area => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-orange m-1';
            btn.textContent = area;
            btn.addEventListener('click', () => mostrarMesas(area));
            areasTabsPV.appendChild(btn);
        });

        function mostrarMesas(area) {
            mesasPV.innerHTML = '';
            mesas[area].forEach(mesa => {
                const div = document.createElement('div');
                div.className = 'mesa-card';
                div.textContent = mesa.numero;
                if (mesa.estado !== 'Disponible') div.classList.add('ocupada');
                div.addEventListener('click', () => {
                    if (mesa.estado !== 'Disponible') return alert('Mesa ocupada');
                    abrirPedido(area, mesa);
                });
                mesasPV.appendChild(div);
            });
        }

        function abrirPedido(area, mesa) {
            mesaActiva = { area, numero: mesa.numero };
            mesaSeleccionadaSpan.textContent = mesa.numero;
            pedidoActual = [];
           cuentaBody.innerHTML = '';

            totalCuenta.textContent = '0.00';

            productosContainer.innerHTML = '';
            menu.forEach(item => {
                const card = document.createElement('div');
                card.className = 'producto-card';
                card.innerHTML = `${item.nombre}<br>$${item.precio}`;
                card.addEventListener('click', () => agregarProducto(item));
                productosContainer.appendChild(card);
            });

            modalPedido.show();
        }

        function agregarProducto(item) {
            const cantidad = 1;
            const comentario = prompt(`Agregar comentario de preparación para ${item.nombre}`, '') || '';
            const productoPedido = { ...item, cantidad, comentario };
            pedidoActual.push(productoPedido);
            renderCuenta();
        }

        function renderCuenta() {
            cuentaBody.innerHTML = '';
            let total = 0;

            pedidoActual.forEach((p, idx) => {
                const subtotal = p.precio * p.cantidad;
                total += subtotal;

                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${p.nombre}</td>
            <td>
                <button class="btn btn-sm btn-outline-secondary"
                    onclick="cambiarCantidad(${idx}, -1)">−</button>

                <span class="mx-2">${p.cantidad}</span>

                <button class="btn btn-sm btn-outline-secondary"
                    onclick="cambiarCantidad(${idx}, 1)">+</button>
            </td>
            <td>$${subtotal.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-danger"
                    onclick="eliminarProducto(${idx})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
                cuentaBody.appendChild(tr);
            });

            totalCuenta.textContent = total.toFixed(2);
            actualizarTotales();
        }

        function cambiarCantidad(index, cambio) {
            pedidoActual[index].cantidad += cambio;

            if (pedidoActual[index].cantidad <= 0) {
                pedidoActual.splice(index, 1);
            }

            renderCuenta();
        }

        function eliminarProducto(index) {
            pedidoActual.splice(index, 1);
            renderCuenta();
        }



        // Confirmar pedido
        document.getElementById('confirmarPedido').addEventListener('click', () => {
            if (pedidoActual.length === 0) return alert('Agregue productos al pedido');

            // Guardar orden en Cocina (localStorage)
            let cocina = JSON.parse(localStorage.getItem('ordenesCocina')) || [];
            cocina.push({ mesa: mesaActiva.numero, area: mesaActiva.area, productos: pedidoActual, estado: 'En preparación' });
            localStorage.setItem('ordenesCocina', JSON.stringify(cocina));

            // Cambiar estado de mesa
            mesas[mesaActiva.area].forEach(m => { if (m.numero === mesaActiva.numero) m.estado = 'Ocupada'; });
            localStorage.setItem('disenoMesas', JSON.stringify(mesas));

            modalPedido.hide();
            mostrarMesas(mesaActiva.area);
            alert('Pedido enviado a cocina');
        });

function agruparProductos(items) {
    const map = {};

    items.forEach(p => {
        if (!map[p.nombre]) {
            map[p.nombre] = {
                nombre: p.nombre,
                cantidad: p.cantidad,
                precio: p.precio
            };
        } else {
            map[p.nombre].cantidad += p.cantidad;
        }
    });

    return Object.values(map);
}



        // Imprimir ticket
        document.getElementById('imprimirTicket').addEventListener('click', () => {
            if (pedidoActual.length === 0) return alert('Agregue productos');

            const subtotal = pedidoActual.reduce((acc, p) => acc + (p.precio * p.cantidad), 0);
            const totalFinal = subtotal + propina;

            const itemsAgrupados = agruparProductos(pedidoActual);

            const ticketData = {
                mesa: mesaActiva.numero,
                area: mesaActiva.area,
                fecha: new Date().toLocaleString(),
                items: itemsAgrupados,
                subtotal,
                propina,
                tipoPropina,
                totalFinal,
                formaPago,
                efectivoRecibido,
                cambio
            };

            localStorage.setItem('ticketActual', JSON.stringify(ticketData));
            window.open('ticket.html', '_blank', 'width=320,height=600');
        });




        // Cerrar mesa
        document.getElementById('cerrarMesa').addEventListener('click', () => {
            if (!mesaActiva) return;

            // Guardar venta en historial
            let historial = JSON.parse(localStorage.getItem('historialVentas')) || [];
            let total = pedidoActual.reduce((acc, p) => acc + p.precio * p.cantidad, 0);
            historial.push({
                mesa: mesaActiva.numero,
                area: mesaActiva.area,
                productos: pedidoActual,
                total: total,
                fecha: new Date().toLocaleString()
            });
            localStorage.setItem('historialVentas', JSON.stringify(historial));

            // Limpiar pedido
            pedidoActual = [];
            cuentaActual.innerHTML = '';
            totalCuenta.textContent = '0.00';

            // Cambiar estado de mesa
            mesas[mesaActiva.area].forEach(m => { if (m.numero === mesaActiva.numero) m.estado = 'Disponible'; });
            localStorage.setItem('disenoMesas', JSON.stringify(mesas));

            modalPedido.hide();
            mostrarMesas(mesaActiva.area);
            alert('Mesa cerrada y venta registrada');
        });
        let propina = 0;
        let tipoPropina = 'Ninguna';
        let formaPago = 'efectivo';
        let efectivoRecibido = 0;
        let cambio = 0;


        function aplicarPropinaPorcentaje(porcentaje) {
            const subtotal = parseFloat(totalCuenta.textContent);
            propina = subtotal * porcentaje;
            tipoPropina = `${porcentaje * 100}%`;
            actualizarTotales();
        }

        function aplicarPropinaEfectivo(monto) {
            propina = parseFloat(monto) || 0;
            tipoPropina = 'Efectivo';
            actualizarTotales();
        }

        function actualizarTotales() {
            const subtotal = parseFloat(totalCuenta.textContent);
            document.getElementById('propinaMonto').textContent = propina.toFixed(2);
            document.getElementById('totalFinal').textContent = (subtotal + propina).toFixed(2);
            actualizarPago();
        }

        function actualizarPago() {
            formaPago = document.getElementById('formaPago').value;

            const totalFinal = parseFloat(document.getElementById('totalFinal').textContent) || 0;
            efectivoRecibido = parseFloat(document.getElementById('pagoEfectivo').value) || 0;

            cambio = 0;

            if (formaPago === 'efectivo') {
                cambio = efectivoRecibido - totalFinal;
            }

            if (formaPago === 'mixto') {
                cambio = efectivoRecibido > totalFinal ? efectivoRecibido - totalFinal : 0;
            }

            document.getElementById('cambio').textContent = cambio > 0 ? cambio.toFixed(2) : '0.00';
        }

    </script>
</body>

</html>