<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Punto de Venta | Restaurant Hub</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/sidebar.css">

    <style>
        .mesa-card {
            width: 80px;
            height: 80px;
            margin: 5px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #28a745;
            color: #fff;
            font-weight: bold;
        }

        .mesa-card.ocupada {
            background-color: #e74c3c;
        }

        .mesa-card:hover {
            opacity: 0.8;
        }

        .producto-card {
            width: 150px;
            margin: 5px;
            border-radius: 10px;
            background-color: #ff8c00;
            color: #fff;
            text-align: center;
            padding: 10px;
            cursor: pointer;
        }

        .producto-card:hover {
            background-color: #e67e00;
        }

        #cuentaActual {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body>

    <div class="d-flex">
        <aside class="sidebar">
            <div class="sidebar-header">RestaurantHub</div>
            <ul class="sidebar-menu">
                <li><a href="../dashboard.html">Dashboard</a></li>
                <li class="active"><a href="pages/punto_venta.html">Punto de Venta</a></li>
                <li><a href="/pages/caja.html">Caja</a></li>
                <li><a href="/pages/reservas.html">Reservas</a></li>
                <li><a href="/pages/mesas.html">Mesas</a></li>
                <li><a href="/pages/inventario.html">Inventario</a></li>
                <li><a href="/pages/categorias.html">Categorias</a></li>
                <li><a href="/pages/cocina.html">Cocina</a></li>
                <li><a href="/pages/clientes.html">Clientes</a></li>
                <li><a href="/pages/reportes.html">Reportes</a></li>
                <li><a href="/pages/usuarios.html">Usuarios</a></li>
                <li><a href="/pages/configuracion.html">Configuración</a></li>
            </ul>

        </aside>

        <div class="container-fluid p-4">

            <h2 class="titulo">Punto de Venta</h2>

            <!-- Selección de áreas -->
            <div class="mt-3 mb-3" id="areasTabsPV"></div>

            <!-- Mesas disponibles -->
            <div class="d-flex flex-wrap" id="mesasPV"></div>

            <!-- Modal de pedidos -->
            <div class="modal fade" id="modalPedido" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content modal-dark">
                        <div class="modal-header">
                            <h5 class="modal-title">Mesa <span id="mesaSeleccionada"></span></h5>
                            <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <!-- Productos -->
                                <div class="col-md-8 d-flex flex-wrap" id="productosContainer"></div>

                                <!-- Cuenta -->
                                <div class="col-md-4">
                                    <h5>Cuenta Actual</h5>
                                    <div id="cuentaActual" class="border p-2 bg-light"></div>
                                    <h5 class="mt-2">Total: $<span id="totalCuenta">0.00</span></h5>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button class="btn btn-success" id="confirmarPedido">Confirmar Pedido</button>
                            <button class="btn btn-info" id="imprimirTicket">Imprimir Ticket</button>
                            <button class="btn btn-success" id="cerrarMesa">Cerrar Mesa</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let mesas = JSON.parse(localStorage.getItem('disenoMesas')) || {};
        let areas = Object.keys(mesas);

        const areasTabsPV = document.getElementById('areasTabsPV');
        const mesasPV = document.getElementById('mesasPV');

        const modalPedido = new bootstrap.Modal(document.getElementById('modalPedido'));
        const mesaSeleccionadaSpan = document.getElementById('mesaSeleccionada');
        const productosContainer = document.getElementById('productosContainer');
        const cuentaActual = document.getElementById('cuentaActual');
        const totalCuenta = document.getElementById('totalCuenta');

        let mesaActiva = null;
        let pedidoActual = [];

        // Menú ejemplo (puedes cargar dinámicamente de tu base de datos)
        const menu = [
            { categoria: 'Bebidas', nombre: 'Coca-Cola', precio: 25 },
            { categoria: 'Bebidas', nombre: 'Agua', precio: 15 },
            { categoria: 'Comida', nombre: 'Hamburguesa', precio: 80 },
            { categoria: 'Comida', nombre: 'Pizza', precio: 120 },
            { categoria: 'Postres', nombre: 'Helado', precio: 50 }
        ];

        // Mostrar áreas como botones
        areas.forEach(area => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-orange m-1';
            btn.textContent = area;
            btn.addEventListener('click', () => mostrarMesas(area));
            areasTabsPV.appendChild(btn);
        });

        function mostrarMesas(area) {
            mesasPV.innerHTML = '';
            mesas[area].forEach(mesa => {
                const div = document.createElement('div');
                div.className = 'mesa-card';
                div.textContent = mesa.numero;
                if (mesa.estado !== 'Disponible') div.classList.add('ocupada');
                div.addEventListener('click', () => {
                    if (mesa.estado !== 'Disponible') return alert('Mesa ocupada');
                    abrirPedido(area, mesa);
                });
                mesasPV.appendChild(div);
            });
        }

        function abrirPedido(area, mesa) {
            mesaActiva = { area, numero: mesa.numero };
            mesaSeleccionadaSpan.textContent = mesa.numero;
            pedidoActual = [];
            cuentaActual.innerHTML = '';
            totalCuenta.textContent = '0.00';

            productosContainer.innerHTML = '';
            menu.forEach(item => {
                const card = document.createElement('div');
                card.className = 'producto-card';
                card.innerHTML = `${item.nombre}<br>$${item.precio}`;
                card.addEventListener('click', () => agregarProducto(item));
                productosContainer.appendChild(card);
            });

            modalPedido.show();
        }

        function agregarProducto(item) {
            const cantidad = 1;
            const comentario = prompt(`Agregar comentario de preparación para ${item.nombre}`, '') || '';
            const productoPedido = { ...item, cantidad, comentario };
            pedidoActual.push(productoPedido);
            renderCuenta();
        }

        function renderCuenta() {
            cuentaActual.innerHTML = '';
            let total = 0;
            pedidoActual.forEach((p, idx) => {
                const div = document.createElement('div');
                const subtotal = p.precio * p.cantidad;
                total += subtotal;
                div.textContent = `${p.nombre} x${p.cantidad} - $${subtotal} ${p.comentario ? '(' + p.comentario + ')' : ''}`;
                cuentaActual.appendChild(div);
            });
            totalCuenta.textContent = total.toFixed(2);
        }

        // Confirmar pedido
        document.getElementById('confirmarPedido').addEventListener('click', () => {
            if (pedidoActual.length === 0) return alert('Agregue productos al pedido');

            // Guardar orden en Cocina (localStorage)
            let cocina = JSON.parse(localStorage.getItem('ordenesCocina')) || [];
            cocina.push({ mesa: mesaActiva.numero, area: mesaActiva.area, productos: pedidoActual, estado: 'En preparación' });
            localStorage.setItem('ordenesCocina', JSON.stringify(cocina));

            // Cambiar estado de mesa
            mesas[mesaActiva.area].forEach(m => { if (m.numero === mesaActiva.numero) m.estado = 'Ocupada'; });
            localStorage.setItem('disenoMesas', JSON.stringify(mesas));

            modalPedido.hide();
            mostrarMesas(mesaActiva.area);
            alert('Pedido enviado a cocina');
        });

        // Imprimir ticket
        document.getElementById('imprimirTicket').addEventListener('click', () => {
            if (pedidoActual.length === 0) return alert('Agregue productos al pedido');

            let contenido = `TICKET DE PEDIDO - Mesa ${mesaActiva.numero} (${mesaActiva.area})\n\n`;
            let total = 0;
            pedidoActual.forEach(p => {
                const subtotal = p.precio * p.cantidad;
                total += subtotal;
                contenido += `${p.nombre} x${p.cantidad} - $${subtotal.toFixed(2)} ${p.comentario ? '(' + p.comentario + ')' : ''}\n`;
            });
            contenido += `\nTOTAL: $${total.toFixed(2)}\n\nGracias por su preferencia!`;

            const ventana = window.open('', 'Ticket', 'width=400,height=600');
            ventana.document.write(`<pre>${contenido}</pre>`);
            ventana.document.close();
            ventana.print();
        });

        // Cerrar mesa
        document.getElementById('cerrarMesa').addEventListener('click', () => {
            if (!mesaActiva) return;

            // Guardar venta en historial
            let historial = JSON.parse(localStorage.getItem('historialVentas')) || [];
            let total = pedidoActual.reduce((acc, p) => acc + p.precio * p.cantidad, 0);
            historial.push({
                mesa: mesaActiva.numero,
                area: mesaActiva.area,
                productos: pedidoActual,
                total: total,
                fecha: new Date().toLocaleString()
            });
            localStorage.setItem('historialVentas', JSON.stringify(historial));

            // Limpiar pedido
            pedidoActual = [];
            cuentaActual.innerHTML = '';
            totalCuenta.textContent = '0.00';

            // Cambiar estado de mesa
            mesas[mesaActiva.area].forEach(m => { if (m.numero === mesaActiva.numero) m.estado = 'Disponible'; });
            localStorage.setItem('disenoMesas', JSON.stringify(mesas));

            modalPedido.hide();
            mostrarMesas(mesaActiva.area);
            alert('Mesa cerrada y venta registrada');
        });

    </script>
</body>

</html>